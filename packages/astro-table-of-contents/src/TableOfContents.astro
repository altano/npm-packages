---
import type { MarkdownHeading } from "astro";

export type Props = {
  /**
   * The `headings` prop, generated by Astro for markdown.
   */
  headings: MarkdownHeading[];
  /**
   * A CSS class to apply to the root `<ul>` element.
   */
  class?: string | undefined;
  /**
   * The minimum depth to render headings from, inclusive. e.g.
   * `fromDepth={2}`` would render headings with depth 2 and above.
   */
  fromDepth?: number | undefined;
  /**
   * The maximum depth to render headings to, inclusive. e.g.
   * `toDepth={5}`` would render headings up to depth 5 but nothing above.
   */
  toDepth?: number | undefined;
  /**
   * Only for internal use, do not specify this prop.
   */
  currentDepth?: number | undefined;
};

function getLowestDepth(headings: MarkdownHeading[]) {
  const depths = headings.map((it) => it.depth);
  return Math.min(...depths);
}

const {
  headings,
  toDepth = Number.POSITIVE_INFINITY,
  fromDepth = getLowestDepth(headings),
  currentDepth = fromDepth,
  class: className,
  ...rest // not actually empty: preserves astro attributes like css data scope
} = Astro.props;

const currentDepthHeadings = headings.filter((it) => it.depth === currentDepth);

// our aria-level is always 1-indexed, regardless of where we started in the tree
const level = currentDepth - fromDepth + 1;
---

<ul class:list={[className]} {...rest}>
  {
    currentDepthHeadings.map((it, idx) => {
      const nextHeading = currentDepthHeadings[idx + 1];
      const subHeadings = headings.slice(
        headings.indexOf(it) + 1,
        nextHeading ? headings.indexOf(nextHeading) : undefined,
      );
      const hasSubHeadings = subHeadings.length > 0;
      const shouldRenderSubHeadings = toDepth > it.depth && hasSubHeadings;

      return (
        <li aria-level={level}>
          {it.slug ? <a href={`#${it.slug}`}>{it.text}</a> : it.text}
          {shouldRenderSubHeadings ? (
            <Astro.self
              {...Astro.props}
              headings={subHeadings}
              currentDepth={it.depth + 1}
              fromDepth={fromDepth}
            />
          ) : null}
        </li>
      );
    })
  }
</ul>
