name: test

# As recommended by Graphite
# (https://graphite.dev/docs/github-configuration-guidelines#github-actions)
on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]

# Cancel in-progress jobs for the same work
# (https://graphite.dev/docs/troubleshooting#why-are-my-actions-running-twice)
concurrency:
  group: ${{ github.repository }}-${{ github.workflow }}-${{ github.ref }}-${{ github.ref == 'refs/heads/main' && github.sha || ''}}
  cancel-in-progress: true

# Use Turborepo remote caching w/ custom cache server
env:
  TURBO_API: ${{ vars.TURBO_API }}
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

jobs:
  build:
    # TODO: test running in devbox but with minimal devbox.json
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Prepare
        # Runs OUTSIDE of Devbox b/c we want this to run as fast as possible.
        uses: ./.github/actions/install-tools-and-deps
      - name: Build
        run: pnpm turbo run build --summarize
      - name: Summarize Turbo
        uses: ./.github/actions/turbo-summarize

  lint:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Prepare
        uses: ./.github/actions/install-tools-and-deps
      - name: Lint
        run: pnpm turbo run lint --summarize
      - name: Summarize Turbo
        uses: ./.github/actions/turbo-summarize

  format:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Prepare
        uses: ./.github/actions/install-tools-and-deps
      - name: Format
        run: pnpm turbo run format --summarize
      - name: Summarize Turbo
        uses: ./.github/actions/turbo-summarize

  check:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Prepare
        uses: ./.github/actions/install-tools-and-deps
      - name: Check
        run: pnpm turbo run check --summarize
      - name: Summarize Turbo
        uses: ./.github/actions/turbo-summarize

  test-unit:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Prepare
        # Runs INSIDE Devbox
        uses: ./.github/actions/install-devbox
      - name: Run tests
        run: devbox run pnpm turbo run test:unit --summarize
      - name: Summarize Turbo
        uses: ./.github/actions/turbo-summarize

  # TODO Consider using playwright docker container
  test-e2e:
    # These have to run outside of Devbox, since Devbox doesn't play well with Playwright
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Prepare
        uses: ./.github/actions/install-tools-and-deps
      - name: Run tests
        run: pnpm turbo run test:e2e --summarize
      - name: Summarize Turbo
        uses: ./.github/actions/turbo-summarize
      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: "**/playwright-report/"
          retention-days: 30

  # When this completes, all validation is. This is convenient because we can
  # make one job required in the repository settings and have code here to
  # define what that means, instead of having to define all the required jobs
  # separately in the repository settings, in sync with this file.
  test:
    needs: [build, lint, format, check, test-unit, test-e2e]
    runs-on: ubuntu-latest
    steps:
      - run: echo "Done."
